## Bug Fixes

### Fixed Nested LATERAL Join Bug for Correlated Subqueries

Fixed a bug where nested collections using correlated subqueries (`toNumberList()`, `toStringList()`, `count()`, etc.) inside a parent LATERAL join would generate invalid SQL.

**Before (broken):**
```typescript
db.productPriceTimeSlots.select(slot => ({
  items: slot.productPrices.select(price => ({
    capacityGroupIds: price.productPriceCapacityGroups.select(cg => ({
      id: cg.capacityGroupId,
    })).toNumberList('capacityGroupIds'),
  })).toList('items'),
}))
```

This would generate SQL that incorrectly referenced `"orders"."id"` instead of the aliased table name `"lateral_0_orders"."id"` inside the LATERAL subquery, causing the error:
```
PostgresError: relation "lateral_1" does not exist
```
or
```
PostgresError: invalid reference to FROM-clause entry for table "orders"
```

**After (fixed):** The query now correctly uses the parent collection's aliased table name in nested correlated subqueries.

### Fixed Scalar Aggregations Inside Nested Collections

Fixed a bug where scalar aggregations (`count()`, `min()`, `max()`, `sum()`) inside nested collections would return `{}` instead of the actual value.

**Before (broken):**
```typescript
db.users.select(u => ({
  orders: u.orders!.select(o => ({
    orderId: o.id,
    taskCount: o.orderTasks!.count(),  // Returned {} instead of number
  })).toList('orders'),
}))
```

**After (fixed):** Scalar aggregations now correctly return their numeric values.

### Fixed Sibling LATERAL Collections Interfering With Each Other

Fixed a regression where sibling LATERAL collections at the same level would incorrectly share table alias mappings, causing SQL errors like `missing FROM-clause entry for table "lateral_X_tableName"`.

This occurred in complex queries with multiple collections on the same entity, where one collection's internal alias would leak into another sibling collection's correlated subquery.

**After (fixed):** The `lateralTableAliasMap` is now properly scoped - each collection saves and restores the map state after building, ensuring sibling collections don't affect each other while still allowing parent-to-child alias propagation for truly nested collections.

---

### Technical Details

#### Nested LATERAL Join Fix
- Modified `buildCorrelatedSubqueryAggregation()` in `lateral-collection-strategy.ts` to look up the parent collection's aliased table name from `context.lateralTableAliasMap` when building the WHERE clause correlation
- Modified `processField()` in `query-builder.ts` to only create `nestedCteJoin` when there's actually a join clause needed (CTE or LATERAL with join clause), not for correlated subqueries

#### Scalar Aggregation Fix
- Modified `processField()` in `query-builder.ts` to detect scalar aggregations (`COUNT`, `MIN`, `MAX`, `SUM`) and skip attaching `nestedCollectionInfo` for them, since the result is a scalar value that doesn't need transformation

#### Sibling Collection Isolation Fix
- Modified `buildCTE()` in `query-builder.ts` to save and restore the `lateralTableAliasMap` state before and after building each collection, preventing sibling collections from seeing each other's internal aliases

### Files Changed

- `src/query/query-builder.ts` - Fixed nested collection processing and sibling isolation
- `src/query/strategies/lateral-collection-strategy.ts` - Added lateral table alias lookup for nested collections
- `tests/queries/lateral-strategy.test.ts` - Added comprehensive tests for nested collections and sibling isolation

### New Test Entities

Added new entities to the test database that mirror the complex ecommerce schema pattern for comprehensive testing:

- `Product` - Main product entity
- `ProductPrice` - Product pricing with season support
- `ProductPriceCapacityGroup` - Join table for capacity groups
- `CapacityGroup` - Capacity group reference
- `Tag` - Tag entity
- `ProductTag` - Join table linking products to tags

### New Tests

Added 4 complex ecommerce pattern tests that cover the production query patterns:

1. `complex ecommerce pattern: sibling collections with nested toNumberList and navigation` - Tests sibling collections where one has navigation (pt.tag!.id)
2. `complex ecommerce pattern: deeply nested capacityGroupIds inside prices` - Tests nested collections inside LATERAL joins
3. `complex ecommerce pattern: combined sibling collections with deeply nested queries` - Tests multiple siblings with both nested collections and navigation
4. `complex ecommerce pattern: sibling collections where one navigates back to parent table` - Tests navigation back to parent table within nested collection
